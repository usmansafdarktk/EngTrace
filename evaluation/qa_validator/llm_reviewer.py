import os
from dotenv import load_dotenv
import json
import google.generativeai as genai
from . import prompt_templates

def setup_api_key():
    """Configures the Generative AI API key."""
    load_dotenv()
    try:
        api_key = os.environ.get("API_KEY")
        if not api_key:
            raise KeyError
        genai.configure(api_key=api_key)
    except KeyError:
        print("Error: API_KEY environment variable not set or empty.")
        print("Please set the variable with your API key from https://aistudio.google.com/")
        exit(1)

def validate_template_with_llm(template_code: str, instances: list, template_name: str):
    """
    Uses a Large Language Model to validate an EngChain problem template.

    Args:
        template_code: The full source code of the template as a string.
        instances: A list of (question, solution) tuples generated by the template.
        template_name: The name of the template function being evaluated.

    Returns:
        A dictionary containing the LLM's structured evaluation, or None on failure.
    """
    load_dotenv()
    model = genai.GenerativeModel(os.environ.get("MODEL_NAME"))

    prompt = prompt_templates.USER_PROMPT_TEMPLATE.format(
        template_code=template_code,
        q1=instances[0][0], s1=instances[0][1],
        q2=instances[1][0], s2=instances[1][1],
        q3=instances[2][0], s3=instances[2][1]
    )
    
    full_prompt = f"{prompt_templates.SYSTEM_PROMPT}\n{prompt}"
    
    print(f"Contacting LLM for peer review of '{template_name}'... Please wait.")
    
    try:
        response = model.generate_content(full_prompt)
        cleaned_text = response.text.strip().lstrip("```json").rstrip("```")
        json_response = json.loads(cleaned_text)
        return json_response
        
    except json.JSONDecodeError:
        print(f"Error: Failed to decode JSON from LLM response for '{template_name}'.\nResponse received:\n{response.text}")
        return None
    except Exception as e:
        print(f"An unexpected error occurred during LLM validation for '{template_name}': {e}")
        return None
